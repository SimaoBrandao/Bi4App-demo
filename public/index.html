<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Demonstração da Bi4App — extração dos dados do QR Code do Bilhete de Identidade</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="estilo.css">

  <style>
    /* Máscara somente na apresentação */

    .campo-mascarado {
      color: transparent;
      position: relative;
    }

    .campo-mascarado::after {
      content: attr(data-mask);
      color: #000;
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
    }

    /* quando o usuário clica → mostrar valor real */
    .campo-mascarado:focus {
      color: black;
    }

    .campo-mascarado:focus::after {
      content: "";
    }
  </style>

</head>
<body>

<main>
  <h1>Demonstração da Bi4App — leitura do QR Code e preenchimento automático</h1>

  <button type="button" id="botaoIniciarLeitura">Iniciar Leitura do QR Code</button>
  <button type="button" id="botaoPararLeitura" style="display:none;">Parar Leitura</button>

  <div id="status" style="margin-top: 10px; font-weight: bold;"></div>
  <video id="video" width="300" height="200" autoplay muted playsinline></video>

  <form id="formulario" autocomplete="off">

    <input type="text" id="nomeCompleto">
    <input type="text" id="numeroDoBI">
    <input type="text" id="provinciaNascimento">
    <input type="text" id="dataNascimento">
    <input type="text" id="sexo">
    <input type="text" id="estadoCivil">
    <input type="text" id="dataEmissao">
    <input type="text" id="dataValidade">
    <input type="text" id="provinciaEmissoraDoBi">

    <input type="number" id="idadeComBaseNoAnoDeNascimento">
    <input type="number" id="idadeComBaseNoMesEAnoDeNascimento">

  </form>
</main>

<script type="module">
import { LeitorQRCode } from './LeitorQRCode.js';

const leitor = new LeitorQRCode({
  botaoIniciar: document.getElementById('botaoIniciarLeitura'),
  botaoResetar: document.getElementById('botaoPararLeitura'),
  video: document.getElementById('video'),
  status: document.getElementById('status'),
  container: document.getElementById('formulario'),
});

await leitor.inicializar();

leitor.on("processado", () => {
  requestAnimationFrame(mascararSomenteNaApresentacao);
});

document
  .getElementById("formulario")
  .addEventListener("change", mascararSomenteNaApresentacao);

/* ================================
   FUNÇÕES DE MÁSCARA (APRESENTAÇÃO)
   ================================ */

function maskDataNascimento(v) {
  const p = v.split("/");
  if (p.length !== 3) return v;
  return `${p[0]}/**/****`;
}

function maskUltimoDigito(v) {
  const s = v.toString();
  if (s.length <= 1) return "X";
  return s.slice(0, -1) + "X";
}

function maskNumeroBI(bi) {
  let zeros = 0, mascarando = false, r = "";

  for (let c of bi) {

    if (c === "0") zeros++;
    if (zeros >= 3 && !mascarando) mascarando = true;

    if (mascarando && c === "L") {
      mascarando = false;
      r += "L";
      continue;
    }

    r += mascarando ? "*" : c;
  }

  return r;
}

/* ================================
   APLICAÇÃO SÓ NA INTERFACE
   ================================ */

function aplicarMascaraApresentacao(input, getMask) {

  if (!input || !input.value) return;

  input.classList.add("campo-mascarado");

  // guarda o valor verdadeiro apenas uma vez
  if (!input.dataset.realValue)
    input.dataset.realValue = input.value;

  // cria a máscara visual
  input.dataset.mask = getMask(input.dataset.realValue);

  // foco → mostra valor real
  input.addEventListener("focus", () => {
    input.value = input.dataset.realValue;
  });

  // blur → reaplica máscara
  input.addEventListener("blur", () => {
    input.value = input.dataset.realValue;
    input.dataset.mask = getMask(input.dataset.realValue);
  });
}

function mascararSomenteNaApresentacao() {

  aplicarMascaraApresentacao(
    document.getElementById("dataNascimento"),
    maskDataNascimento
  );

  aplicarMascaraApresentacao(
    document.getElementById("idadeComBaseNoAnoDeNascimento"),
    maskUltimoDigito
  );

  aplicarMascaraApresentacao(
    document.getElementById("idadeComBaseNoMesEAnoDeNascimento"),
    maskUltimoDigito
  );

  aplicarMascaraApresentacao(
    document.getElementById("numeroDoBI"),
    maskNumeroBI
  );
}
</script>

<footer>
  <p>Desenvolvido por <strong>Simão Brandão</strong></p>
</footer>

</body>
</html>
